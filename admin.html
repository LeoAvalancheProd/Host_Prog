<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Login ‚Äî Festival Lineup</title>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f6f7fb;color:#111;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{background:#fff;padding:28px;border-radius:12px;box-shadow:0 10px 30px rgba(20,20,40,0.06);width:360px;}
    h1{font-size:1.2rem;margin:0 0 8px}
    .hint{color:#666;font-size:0.9rem;margin-bottom:18px}
    input{width:100%;padding:12px 14px;border-radius:8px;border:1px solid #e6e9ef;margin-bottom:12px;font-size:1rem}
    button{width:100%;padding:12px;border-radius:8px;border:none;background:#FF6B35;color:white;font-weight:700;cursor:pointer}
    .error{color:#c53030;margin-bottom:12px;display:none}
    .note{font-size:0.85rem;color:#666;margin-top:12px}
  </style>
</head>
<body>
  <div id="loginCard" class="card">
    <h1>Admin Login</h1>
    <div class="hint">Enter the admin password to access the Lineup Manager.</div>
    <div id="err" class="error">Invalid password</div>
    <div id="attemptInfo" class="hint" style="display:block;font-size:0.9rem;color:#666;margin-bottom:8px"></div>
    <input id="pwd" type="password" placeholder="Password">
    <button id="submit">Unlock Admin</button>
    <div class="note">Password is stored only in your browser session (client-side). Use carefully.</div>
  </div>

  <!-- Admin App (hidden until authenticated) -->
  <div id="adminApp" style="display:none; max-width:1100px; width:100%; padding:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <h2 style="margin:0">üõ†Ô∏è Lineup Manager (Admin)</h2>
      <div style="display:flex;gap:12px;align-items:center">
        <a href="/" target="_blank" class="btn">Open Site</a>
        <button id="adminLogout" class="btn btn-danger">Logout</button>
      </div>
    </div>

    <div style="display:flex;gap:18px;flex-wrap:wrap;">
      <div style="flex:1;min-width:320px;">
        <div style="background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(10,20,40,0.04);">
          <h3 style="margin-top:0">Artists</h3>
          <div class="artist-list-admin" id="adminArtistList"></div>
        </div>
      </div>

      <div style="width:420px;">
        <div style="background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(10,20,40,0.04);">
          <h3 style="margin-top:0">Add / Edit Artist</h3>
          <form id="adminAddArtistForm">
            <input type="hidden" id="adminEditId">
            <div style="margin-bottom:12px;"><label style="font-weight:600">Name *</label><input id="adminArtistName" class="form-input" required></div>
            <div style="margin-bottom:12px;"><label style="font-weight:600">Stage *</label><input id="adminArtistStage" class="form-input" required list="adminStageList"><datalist id="adminStageList"></datalist></div>
            <div style="display:flex;gap:8px;margin-bottom:12px;"><div style="flex:1"><label style="font-weight:600">Date *</label><input id="adminArtistDate" type="date" class="form-input" required></div><div style="width:120px"><label style="font-weight:600">Time *</label><input id="adminArtistTime" type="time" class="form-input" required></div></div>
            <div style="margin-bottom:12px;"><label style="font-weight:600">Genre *</label><input id="adminArtistGenre" class="form-input" required list="adminGenreList"><datalist id="adminGenreList"></datalist></div>
            <div style="margin-bottom:12px;"><label style="font-weight:600">Image URL</label><input id="adminArtistImage" class="form-input" placeholder="https://..."></div>
            <div style="margin-bottom:12px;"><label style="font-weight:600">Description</label><textarea id="adminArtistDescription" class="form-textarea" rows="4"></textarea></div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;"><input type="checkbox" id="adminArtistFeatured"><label style="margin:0">Featured</label></div>
            <div style="display:flex;gap:8px;"><button type="submit" class="btn btn-primary" id="adminSaveBtn">üíæ Save</button><button type="button" class="btn" id="adminCancelBtn">Cancel</button></div>
          </form>
        </div>

        <div style="background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(10,20,40,0.04);margin-top:14px;">
          <h3 style="margin-top:0">Data & Settings</h3>
          <div style="margin-bottom:12px;"><button id="adminExportBtn" class="btn btn-success">üì• Export JSON</button></div>
          <div style="margin-bottom:12px;"><input id="adminImportInput" type="file" accept="application/json" class="form-input"></div>
          <div style="margin-bottom:12px;"><button id="adminClearBtn" class="btn btn-danger">üóëÔ∏è Clear All</button></div>
          <hr>
          <p style="margin:0 0 6px 0"><strong>Total Artists:</strong> <span id="adminTotalArtists">0</span></p>
          <p style="margin:0 0 6px 0"><strong>Total Stages:</strong> <span id="adminTotalStages">0</span></p>
          <p style="margin:0"><strong>Total Genres:</strong> <span id="adminTotalGenres">0</span></p>

          <hr style="margin-top:16px">
          <h4 style="margin:8px 0">Activity Log</h4>
          <div style="max-height:220px;overflow:auto;border:1px solid #eee;padding:10px;border-radius:8px;background:#fafafa">
            <div id="adminAuditList"><p style="margin:0;color:#666">No activity yet.</p></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button id="adminExportAuditBtn" class="btn">Export Audit</button>
            <button id="adminClearAuditBtn" class="btn btn-danger">Clear Audit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const PASSWORD = 'M4M2026';
      const submit = document.getElementById('submit');
      const pwd = document.getElementById('pwd');
      const err = document.getElementById('err');
      const attemptInfo = document.getElementById('attemptInfo');
      const loginCard = document.getElementById('loginCard');
      const adminApp = document.getElementById('adminApp');

      // Admin storage key
      const STORAGE_KEY = 'festival_lineup_artists';
      const FAIL_KEY = 'festival_admin_failed';
      const MAX_ATTEMPTS = 5;          // lock after 5 failed attempts
      const LOCKOUT_MS = 10 * 60 * 1000; // 10 minutes lockout
      const COOLDOWN_MS = 3000;       // 3 seconds cooldown after each failed try

      function loadArtists(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        }catch(e){ return []; }
      }

      function saveArtists(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

      function getFailInfo(){
        try{ const raw = localStorage.getItem(FAIL_KEY); return raw ? JSON.parse(raw) : {count:0,lockedUntil:0}; }catch(e){ return {count:0,lockedUntil:0}; }
      }
      function setFailInfo(info){ localStorage.setItem(FAIL_KEY, JSON.stringify(info)); }
      function resetFailInfo(){ localStorage.removeItem(FAIL_KEY); }

      function isLockedOut(){ const info = getFailInfo(); return info.lockedUntil && Date.now() < info.lockedUntil; }
      function lockRemainingMs(){ const info = getFailInfo(); return Math.max(0, (info.lockedUntil || 0) - Date.now()); }

      function recordFailedAttempt(){ const info = getFailInfo(); info.count = (info.count || 0) + 1; if (info.count >= MAX_ATTEMPTS) { info.lockedUntil = Date.now() + LOCKOUT_MS; } setFailInfo(info); updateAttemptDisplay(); }

      function updateAttemptDisplay(){ const info = getFailInfo(); if (isLockedOut()){
          const ms = lockRemainingMs(); const mins = Math.floor(ms/60000); const secs = Math.floor((ms%60000)/1000); attemptInfo.textContent = `Locked due to too many failed attempts. Try again in ${mins}m ${secs}s.`; attemptInfo.style.color = '#c53030';
        } else {
          const left = Math.max(0, MAX_ATTEMPTS - (info.count || 0)); attemptInfo.textContent = `Failed attempts: ${info.count || 0}. Attempts left: ${left}.`; attemptInfo.style.color = '#666';
        }
      }

      // UI elements
      const artistListEl = document.getElementById('adminArtistList');
      const form = document.getElementById('adminAddArtistForm');
      const editIdEl = document.getElementById('adminEditId');
      const nameEl = document.getElementById('adminArtistName');
      const stageEl = document.getElementById('adminArtistStage');
      const dateEl = document.getElementById('adminArtistDate');
      const timeEl = document.getElementById('adminArtistTime');
      const genreEl = document.getElementById('adminArtistGenre');
      const imageEl = document.getElementById('adminArtistImage');
      const descEl = document.getElementById('adminArtistDescription');
      const featuredEl = document.getElementById('adminArtistFeatured');
      const cancelBtn = document.getElementById('adminCancelBtn');
      const exportBtn = document.getElementById('adminExportBtn');
      const importInput = document.getElementById('adminImportInput');
      const clearBtn = document.getElementById('adminClearBtn');
      const logoutBtn = document.getElementById('adminLogout');

      function renderList(){
        const artists = loadArtists();
        artistListEl.innerHTML = '';
        if (artists.length === 0){ artistListEl.innerHTML = '<p>No artists yet.</p>'; }
        const sorted = [...artists].sort((a,b)=> new Date(a.date)-new Date(b.date));
        sorted.forEach(a=>{
          const item = document.createElement('div');
          item.style.display='flex';item.style.justifyContent='space-between';item.style.alignItems='center';item.style.padding='8px 0';
          item.innerHTML = `<div><strong>${a.name}</strong><div style="font-size:0.9rem;color:#666">${a.stage} ‚Ä¢ ${formatDate(a.date)} ${a.time ? ' ‚Ä¢ ' + a.time : ''}</div></div><div style="display:flex;gap:8px"><button data-edit="${a.id}" class="btn">‚úèÔ∏è</button><button data-delete="${a.id}" class="btn btn-danger">üóëÔ∏è</button></div>`;
          artistListEl.appendChild(item);
        });

        // Attach handlers
        artistListEl.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.getAttribute('data-edit'); editArtist(id);}));
        artistListEl.querySelectorAll('[data-delete]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.getAttribute('data-delete'); deleteArtist(id);}));

        updateStats();
        updateDataLists();
      }

      function formatDate(d){ if(!d) return ''; const date = new Date(d+'T00:00:00'); return date.toLocaleDateString(); }

      function resetForm(){ editIdEl.value=''; form.reset(); document.getElementById('adminSaveBtn').textContent='üíæ Save'; }

      function editArtist(id){ const artists=loadArtists(); const a=artists.find(x=>x.id===id); if(!a) return; editIdEl.value=a.id; nameEl.value=a.name; stageEl.value=a.stage; dateEl.value=a.date; timeEl.value=a.time||''; genreEl.value=a.genre; imageEl.value=a.image||''; descEl.value=a.description||''; featuredEl.checked = !!a.featured; document.getElementById('adminSaveBtn').textContent='üíæ Update'; }

      function deleteArtist(id){ const artists=loadArtists(); const artist = artists.find(a=>a.id===id); if(!artist) return; if(!confirm(`Delete "${artist.name}"?`)) return; let remaining = artists.filter(a=>a.id!==id); saveArtists(remaining); recordAudit('delete', `${artist.name}`); renderList(); alert('Deleted'); }

      form.addEventListener('submit', (e)=>{ e.preventDefault(); const artists=loadArtists(); const wasEdit = !!editIdEl.value; const id = editIdEl.value || Date.now().toString(); const artist={ id, name: nameEl.value.trim(), stage: stageEl.value.trim(), date: dateEl.value, time: timeEl.value, genre: genreEl.value.trim(), image: imageEl.value.trim(), description: descEl.value.trim(), featured: featuredEl.checked }; if (wasEdit){ const idx = artists.findIndex(x=>x.id===id); if (idx>-1) artists[idx]=artist; alert('Updated'); recordAudit('update', `${artist.name}`); } else { artists.push(artist); alert('Added'); recordAudit('add', `${artist.name}`); } saveArtists(artists); renderList(); resetForm(); });

      cancelBtn.addEventListener('click', ()=>resetForm());

      exportBtn.addEventListener('click', ()=>{ const data={version:'1.0',exportDate:new Date().toISOString(),artists:loadArtists()}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`festival-lineup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); recordAudit('export', `artists:${loadArtists().length}`); alert('Exported'); });

      importInput.addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ try{ const data=JSON.parse(ev.target.result); if(!data.artists||!Array.isArray(data.artists)) throw new Error('Invalid'); if(!confirm(`Import ${data.artists.length} artists? This will replace current data.`)) return; saveArtists(data.artists); renderList(); recordAudit('import', `artists:${data.artists.length}`); alert('Imported'); }catch(err){ alert('Failed to import'); } }; r.readAsText(f); e.target.value=''; });

      clearBtn.addEventListener('click', ()=>{ if(confirm('Delete ALL artists?')){ saveArtists([]); renderList(); recordAudit('clear_all', 'all artists removed'); alert('Cleared'); } });

      // Audit export/clear handlers
      const exportAuditBtn = document.getElementById('adminExportAuditBtn');
      const clearAuditBtn = document.getElementById('adminClearAuditBtn');
      if (exportAuditBtn) exportAuditBtn.addEventListener('click', ()=>{ const audits = loadAudit(); const blob=new Blob([JSON.stringify({version:'1.0',exportDate:new Date().toISOString(),audits},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`festival-lineup-audit-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); alert('Audit exported'); });
      if (clearAuditBtn) clearAuditBtn.addEventListener('click', ()=>{ if(confirm('Clear audit log?')){ clearAudit(); alert('Audit cleared'); } });

      function updateStats(){ const artists=loadArtists(); document.getElementById('adminTotalArtists').textContent = artists.length; document.getElementById('adminTotalStages').textContent = new Set(artists.map(a=>a.stage)).size; document.getElementById('adminTotalGenres').textContent = new Set(artists.map(a=>a.genre)).size; }

      function updateDataLists(){ const artists=loadArtists(); const stages = [...new Set(artists.map(a=>a.stage))]; const genres = [...new Set(artists.map(a=>a.genre))]; document.getElementById('adminStageList').innerHTML = stages.map(s=>`<option value="${s}">`).join(''); document.getElementById('adminGenreList').innerHTML = genres.map(g=>`<option value="${g}">`).join(''); }

      // --- Audit helpers ---
      const AUDIT_KEY = 'festival_lineup_audit';
      function loadAudit(){ try{ const raw = localStorage.getItem(AUDIT_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
      function saveAudit(arr){ localStorage.setItem(AUDIT_KEY, JSON.stringify(arr)); }
      function recordAudit(action, details){ try{ const arr = loadAudit(); const entry = { ts: Date.now(), action, details: details || '', by: 'admin' }; arr.push(entry); // cap to last 500
          if (arr.length > 500) arr.splice(0, arr.length - 500);
          saveAudit(arr); renderAudit(); }catch(e){ console.warn('Audit record failed', e); } }
      function clearAudit(){ localStorage.removeItem(AUDIT_KEY); renderAudit(); }
      function renderAudit(){ const list = loadAudit(); const container = document.getElementById('adminAuditList'); if(!container) return; if(!list || list.length===0){ container.innerHTML = '<p style="margin:0;color:#666">No activity yet.</p>'; return; } container.innerHTML = list.slice().reverse().map(it=>{ const d = new Date(it.ts); const ts = d.toLocaleString(); const details = it.details ? ` ‚Äî ${it.details}` : ''; return `<div style="padding:6px 0;border-bottom:1px solid #efefef;font-size:0.95rem;color:#222">${ts} ‚Äî <strong>${escapeHtml(it.action)}</strong>${escapeHtml(details)}</div>`; }).join(''); }
      function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function showAdmin(){ loginCard.style.display='none'; adminApp.style.display='block'; renderList(); renderAudit(); }

      // Logout
      logoutBtn.addEventListener('click', ()=>{ sessionStorage.removeItem('festival_admin_auth'); localStorage.removeItem('festival_admin_auth'); recordAudit('logout','admin logged out'); adminApp.style.display='none'; loginCard.style.display='block'; });

      // On load
      (function(){
        if (sessionStorage.getItem('festival_admin_auth') === 'true' || localStorage.getItem('festival_admin_auth') === 'true'){
          const params = new URLSearchParams(window.location.search);
          const ret = params.get('return');
          if (ret){
            const retDecoded = decodeURIComponent(ret);
            if (location.protocol === 'file:' && retDecoded.startsWith('/')){
              window.location.href = 'file://' + retDecoded;
            } else {
              window.location.href = retDecoded;
            }
          } else {
            showAdmin();
          }
        }

        submit.addEventListener('click', ()=>{
          if (pwd.value === PASSWORD){
            sessionStorage.setItem('festival_admin_auth','true');
            localStorage.setItem('festival_admin_auth','true');
            // If a return URL was provided, go back to it (supports file:// and http(s))
            const params = new URLSearchParams(window.location.search);
            const ret = params.get('return');
            if (ret){
              const retDecoded = decodeURIComponent(ret);
              if (location.protocol === 'file:' && retDecoded.startsWith('/')){
                window.location.href = 'file://' + retDecoded;
              } else {
                window.location.href = retDecoded;
              }
              return;
            }
            showAdmin();
          } else {
            err.style.display='block';
          }
        });

        pwd.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit.click(); });
      })();
    })();
  </script>
</body>
</html>